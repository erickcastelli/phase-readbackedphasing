# phase-using-known-from-readbackedphasing.pl and phase_to_vcf.pl
Perl scripts written by Erick C. Castelli, Version 2.5

Molecular Genetics and Bioinformatics Laboratory, School of Medicine, Unesp, Botucatu-SP, Brazil (www.castelli-lab.net). 

System: OSX, Linux, Unix (Windows not supported)

When using the GATK ReadBackedPhasing to get haplotypes from NGS data, some variable sites are straightforwardly phased, but others are not. These include indels, multi-allelic loci and variable sites not presenting another close heterozygous variable site. To get haplotypes for all variable sites, phase-using-known-from-readbackedphasing.pl uses the phased data from a VCF file generated by the GATK ReadBackedPhasing algorithm to create a fragmented .known file, that will be used with the PHASE algorithm to fill in the blanks. This .known file is usually "fragmented", because GATK ReadBackedPhasing may phase some groups of variable sites, but not inform the association (or the phase) between these groups.

Then, phase-using-known-from-readbackedphasing.pl runs the PHASE algorithm considering each of this fragments and compares the PHASE results from multiple runs.

phase_to_vcf.pl to used to convert a .out_pairs obtained with the PHASE algorithm into a phased VCF file.

phase-using-known-from-readbackedphasing.pl is suitable to deal with a small set of variable sites (up to 1000), mainly because the PHASE algorithm is not suitable to large datasets. 

# References

This methodology was described and used at the following manuscripts. If you use this script, please cite them both.

Castelli EC et al. HLA-G variability and haplotypes detected by massively parallel sequencing procedures in the geographicaly distinct population samples of Brazil and Cyprus. Mol Immunol. 2017 Mar;83:115-126. doi: 10.1016/j.molimm.2017.01.020. 

Lima TH et al. HLA-F coding and regulatory segments variability determined by massively parallel sequencing procedures in a Brazilian population sample. Hum Immunol. 2016 Oct;77(10):841-53. doi: 10.1016/j.humimm.2016.07.231. 

# How to use phase-using-known-from-readbackedphasing.pl

First, you need working copies of 
- the PHASE algorithm (download it at http://stephenslab.uchicago.edu/software.html#phase) 
- VCFx software (download it at www.castelli-lab.net/apps/vcfx).

To use the script, at your terminal, type 'perl phase-using-known-from-readbackedphasing.pl'. This will display a list of options to set the script, as it follows:

- -o [output_folder] (optional)
- -t [number of threads] (optional, default: 4)
- -v [input VCF file phased by GATK ReadBackedPhasing] (mandatory)
- -b [path do the PHASE binary] ( not detected, mandatory)
- -x [path do the VCFX binary] ( located at /usr/local/bin/vcfx )
- -p [iteraction, thinning and burning parameters] (e.g. -p '1000 1 100')
- -d [other parameters] (such as -x '-N300 -l12 -d1')
- example: perl phase-fragmented-known-version_2.5.pl -t 6 -v file.vcf 

Option -o

This is optional. You may indicate the output folder here. If you don't, a new folder with the date and time will be created in the same folder where the script is located.

Option -t

This is optional. You may indicate the number of threads to be used. Each thread perform a parallel PHASE run.

Option -v

This is the VCF file. This file should be phased using the GATK ReadBackedPhasing algorithm.

Option -b

Path to the PHASE binary. If not installed in the system, please indicate the full path for the binary (including the binary name) here.

Option -x

Path to the VCFx binary. If not installed in the system, please indicate the full path for the binary (including the binary name) here.

Option -p

You may set the interaction, thinning and burning parameters here. E.g., -p '1000 1 100'. The default value is -p '100 1 100'

Option -d

You may set additional PHASE parameters here, such as the segment size, mutation model, etc. E.g., -d '-l12. 


# The phase-using-known-from-readbackedphasing.pl output folder

At the output folder, you will find:
- original.inp (this is the VCF file converted to the .INP file, by using VCFx phase)
- original.known (this is the fragmented .known file, keeping the phase information from ReadBackePhasing). The presence of "|" means that we don't known the phase between these two fragments.
- original.vcf (this is a copy of the VCF file)
- known.@.known files (these files represent the .known that will be used by the PHASE algorithm in each @ run). There will be as much @ as the maximum number of fragments observed in the original.known file.
- log_run_@.txt (the log file for each PHASE run)
- phase_@.out (the PHASE outputs for each run. including .out_freqs, .out_pairs, and others)
- haplotypes.checked.csv (This is the final file. In here you will find the haplotype pairs for each sample in each run, and the haplotype pairs when not considering the .known file, as well as the compatibility among runs. All pair of haplotypes marked with "ok" under compatibility indicate that, for that sample, the same pair of haplotypes were detected presenting the highest P-value for all runs. Thus, this pair is also compatible with ReadBackedPhasing information.)

# How to use phase_to_vcf.pl

First, you need to take one of the .out_pairs files generated by the PHASE algorithm and make a copy of it. Then, delete all samples that do not present a suitable haplotype pair.

phase_to_vcf.pl will take the haplotype pair with the highest P-value for each sample and convert the data into a phased VCF file, using the original VCF as a draft.

To use phase_to_vcf.pl, at your terminal, type "perl phase_to_vcf.pl"

You will see the options available, such as follows:

- -i [the PHASE out_pairs file]
- -v [the VCF to be used as a draft]
- -o [the output VCF file]

-i option

You need to indicate the .out_pairs file that will be used to get the haplotypes.

-v option

You need to indicate the same VCF file used with phase-using-known-from-readbackedphasing.pl. This file will be used as draft to generate the phased VCF.

-o option

You need to indicate the path and name for the phased VCF file that will be generated.
